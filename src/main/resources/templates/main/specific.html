<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout/specificLayout}">
<th:block layout:fragment="content">
  <section class="contents h-100 ">

    <div class="w-100 h-90 my-3">
      <div id="todolistBox" class="w-90 px-3">
        <div id="todoListWeek" class="font-weight-bold my-3 p-3 category">ì£¼ê°„ í•  ì¼ ëª©ë¡</div>
        <!-- Thymeleaf ì½”ë“œ: ì²´í¬ë°•ìŠ¤ + ë¼ë²¨ í¬í•¨ ì£¼ê°„ í•  ì¼ ëª©ë¡ -->
        <div class="my-2" th:each="category : ${dayTodolist}">
          <!-- ì¹´í…Œê³ ë¦¬ -->
          <div class="d-flex align-items-center category p-2">
            <div class="category-color mr-3"
                 th:style="'background-color:' + ${category.color}"></div>
            <div th:text="${category.category}">ì¹´í…Œê³ ë¦¬ëª…</div>
          </div>

          <!-- ì¹´í…Œê³ ë¦¬ ë‚´ í•  ì¼ -->
          <div class="todolist my-3 py-3 subcategory">
            <div class="my-3 d-flex align-items-center todoCheck" th:each="task : ${category.tasks}">
              <input class="mr-1 task-checkbox" type="checkbox"
                     th:id="'task-' + ${task.id}"
                     th:name="'task-' + ${task.id}"
                     th:checked="${task.isChecked == true}" />

              <label th:for="'task-' + ${task.id}"
                     th:text="${task.todolist}"
                     class="ml-2 task-content"
                     th:classappend="${task.isChecked == true} ? 'completed' : ''">
                í•  ì¼
              </label>
            </div>
          </div>

          <!-- ì„œë¸Œì¹´í…Œê³ ë¦¬ ë°˜ë³µ -->
          <div class="d-flex my-3 py-3 subcategory" th:each="subcategory : ${category.subcategories}">
            <div class="subcategory-color mr-3 mt-2"></div>
            <div>
              <div class="mb-4 mt-1" th:text="${subcategory.subcategory}">ì„œë¸Œì¹´í…Œê³ ë¦¬ëª…</div>
              <div class="todolist">
                <div class="my-3 d-flex align-items-center todoCheck" th:each="subTask : ${subcategory.tasks}">
                  <input class="mr-2 task-checkbox" type="checkbox"
                         th:id="'subTask-' + ${subTask.id}"
                         th:name="'subTask-' + ${subTask.id}"
                         th:checked="${subTask.isChecked == true}" />

                  <label th:for="'subTask-' + ${subTask.id}"
                         th:text="${subTask.todolist}"
                         class="ml-2 task-content"
                         th:classappend="${subTask.isChecked == true} ? 'completed' : ''">
                    ì„œë¸Œ í•  ì¼
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>

    <div id="addBtn" class="d-flex justify-content-center align-items-center">ì¼ì • ì¶”ê°€</div>
  </section>
  <script>
    $(function(){
      $(document).on("click", ".colorList", function() {
        let selectedColor = $(this).attr("data-color"); // í´ë¦­í•œ divì˜ data-color ê°’ ê°€ì ¸ì˜¤ê¸°

        // ê¸°ì¡´ì— ì¶”ê°€ëœ divê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒì„±
        if ($("#selectedColor").length) {
          $("#selectedColor").css("background-color", selectedColor);
        } else {
          let newDiv = `<div id="selectedColor" class="category-color"
                                style="background-color: ${selectedColor}; width: 50px; height: 50px;">
                              </div>`;
          $("#selectedColorContainer").append(newDiv);
        }

        $("#addCategory").removeClass("d-none");
        $(document).on("click", "#addCategory", function() {
          let categoryName = $("#categoryName").val().trim();
          if(!categoryName){
            alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
          }
          $.ajax({
            type:"POST",
            url:"/main/addCategory",
            data:{"name": categoryName, "color": selectedColor},
            success: function(data){
              if(data.code == 200){
                alert(categoryName + " ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
              }
            }
          });
        });
      });

      $("#addBtn").on("click", function(){
        let btn = $("#addBtn");

        btn.addClass("d-none").attr("style", "display: none !important;");
        $.ajax({
          url: "/main/specific/addSchedule",
          success: function(data){
            $("#todolistBox").html(data);
          }
        });
      });
      $(document).on("click", ".scheduleAdd", function(){
        $.ajax({
          url: "/main/specific/addSchedule",
          success: function(data){
            $("#todolistBox").html(data);
          }
        });
      });
      $(document).on("click", ".categoryAdd", function(){
        $.ajax({
          url: "/main/specific/addCategory",
          success: function(data){
            $("#todolistBox").html(data);
          }
        });
      });
      $(document).on("click", ".subcategoryAdd", function(){
        $.ajax({
          url: "/main/specific/addSubategory",
          success: function(data){
            $("#todolistBox").html(data);
          }
        });
      });
    });
    function updateCalendarHref(newDate) {
      let calendarBox = document.getElementById("calenderBox");
      if (calendarBox) {
        calendarBox.setAttribute("href", `/main?date=${newDate}`);
      }
    }

    function updateWeekDates() {
      let formattedDate = selectedDate.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹ ë³€í™˜

      $.ajax({
        url: "/main/updateDates",
        type: "POST",
        data: { "date": formattedDate },
        success: function(data) {
          console.log("Updated week data:", data);

          let dayKeys = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

          dayKeys.forEach(day => {
            let element = document.querySelector(`.${day.toLowerCase()} .date-value`);
            let linkElement = document.querySelector(`.${day.toLowerCase()}`); // í•´ë‹¹ ìš”ì¼ì˜ <a> íƒœê·¸

            if (element && data[day]) {
              let rawDate = data[day]; // ì„œë²„ì—ì„œ ë°›ì€ YYYY-MM-DD í˜•ì‹
              element.setAttribute("data-raw-date", rawDate); // ì›ë³¸ ë‚ ì§œ ì €ì¥

              let parts = rawDate.split("-"); // ["2024", "02", "12"]
              let formattedDate = parts[1] + "/" + parts[2]; // "02/12"
              element.textContent = formattedDate; // í™”ë©´ì— MM/dd í˜•ì‹ìœ¼ë¡œ í‘œì‹œ

              // ğŸ“Œ ê° ìš”ì¼ì˜ <a> íƒœê·¸ href ì—…ë°ì´íŠ¸
              if (linkElement) {
                linkElement.setAttribute("href", `/main/specific?date=${rawDate}`);
              }
            }
          });

          // ğŸ“Œ ì£¼ê°„ ìº˜ë¦°ë” ë§í¬ ì—…ë°ì´íŠ¸ â†’ ì£¼ì˜ ì‹œì‘ì¼(ì›”ìš”ì¼) ê¸°ì¤€
          if (data["Monday"]) {
            updateCalendarHref(data["Monday"]);
          }
        },
        error: function(xhr, status, error) {
          console.error("Error fetching week dates:", error);
        }
      });
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", function() {
      updateWeekDates();
    });
  </script>
</th:block>