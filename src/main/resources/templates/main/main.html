<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout/defaultLayout}">
<th:block layout:fragment="content">
    <section class="contents">

        <div id="calenderBox" class="d-flex justify-content-center align-items-center p-2">
            <div id="calender">
                <div>
                    <div id="weekLabel" class="d-flex justify-content-center mb-2">N월 N주차</div>
                    <div class="d-flex justify-content-between">
                        <div id="prevWeek" class="nav-button">< 지난주</div>
                        <div id="nextWeek" class="nav-button">다음주 ></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dayBox" class="d-flex justify-content-between">
            <a href="/main/specific" class="date monday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">월</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDates.Monday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date tuesday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">화</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDates.Tuesday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date wednesday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">수</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDates.Wednesday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date thursday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">목</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDates.Thursday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date friday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">금</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDates.Friday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date saturday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center text-primary">토</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDates.Saturday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date sunday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center text-danger">일</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDates.Sunday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>

        </div>
    </section>
    <script>
        let selectedDate = new Date(); // 현재 날짜

        // 주간 범위를 가져오는 함수
        function getWeekRange(date) {
            let day = date.getDay();
            let diff = date.getDate() - day + (day === 0 ? -6 : 1); // 월요일 기준으로 주 시작
            let startOfWeek = new Date(date);
            startOfWeek.setDate(diff);

            let endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // 일요일이 주 마지막

            return { start: startOfWeek, end: endOfWeek };
        }

        // 몇 번째 주인지 계산하는 함수
        function getMonthWeekNumber(date) {
            let firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);

            // 첫 월요일 찾기
            let firstMonday = new Date(firstDayOfMonth);
            while (firstMonday.getDay() !== 1) {
                firstMonday.setDate(firstMonday.getDate() + 1);
            }

            let diff = date.getDate() - firstMonday.getDate();
            return Math.floor(diff / 7) + 1;
        }

        // 화면에 주차를 표시하는 함수
        function updateWeekDisplay() {
            let { start, end } = getWeekRange(selectedDate);
            let month = selectedDate.getMonth() + 1;
            let weekNumber = getMonthWeekNumber(selectedDate);

            document.getElementById("weekLabel").innerText =
                `${month}월 ${weekNumber}주차`;
        }

        // 이전 주로 이동 버튼 이벤트
        document.getElementById("prevWeek").addEventListener("click", function() {
            selectedDate.setDate(selectedDate.getDate() - 7);
            updateWeekDisplay();
            updateWeekDates();
        });

        // 다음 주로 이동 버튼 이벤트
        document.getElementById("nextWeek").addEventListener("click", function() {
            selectedDate.setDate(selectedDate.getDate() + 7);
            updateWeekDisplay();
            updateWeekDates();
        });

        // 서버에서 새로운 주간 날짜를 가져와 화면 업데이트하는 함수
        function updateWeekDates() {
            let formattedDate = selectedDate.toISOString().split('T')[0]; // YYYY-MM-DD 형식 변환

            $.ajax({
                url: "/main/updateDates",
                type: "POST",
                data: { "date": formattedDate },
                success: function(data) {
                    console.log("Updated week data:", data);

                    // 각 요일의 날짜 업데이트 (Thymeleaf th:text를 사용한 요소를 직접 수정)
                    document.querySelector(".monday .date-value").innerText = data.Monday;
                    document.querySelector(".tuesday .date-value").innerText = data.Tuesday;
                    document.querySelector(".wednesday .date-value").innerText = data.Wednesday;
                    document.querySelector(".thursday .date-value").innerText = data.Thursday;
                    document.querySelector(".friday .date-value").innerText = data.Friday;
                    document.querySelector(".saturday .date-value").innerText = data.Saturday;
                    document.querySelector(".sunday .date-value").innerText = data.Sunday;
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching week dates:", error);
                }
            });
        }

        // flatpickr 설정
        flatpickr("#weekLabel", {
            enableTime: false,
            dateFormat: "Y-m-d",
            locale: {
                firstDayOfWeek: 1,
                months: {
                    shorthand: [...Array(12)].map((_, i) => `${i + 1}월`),
                    longhand: [...Array(12)].map((_, i) => `${i + 1}월`)
                }
            },
            onChange: function(selectedDates) {
                if (selectedDates.length > 0) {
                    selectedDate = new Date(selectedDates[0]);
                    updateWeekDisplay();
                    updateWeekDates();
                }
            }
        });

        // 초기 실행
        updateWeekDisplay();
        updateWeekDates();

    </script>
</th:block>