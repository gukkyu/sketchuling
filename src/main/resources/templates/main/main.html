<!DOCTYPE html>
<html
        xmlns:th="http://www.thymeleaf.org"
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout/defaultLayout}">
<th:block layout:fragment="content">
    <section class="contents">

        <div id="calenderBox" class="d-flex justify-content-center align-items-center p-2">
            <div id="calender">
                <div>
                    <div id="weekLabel" class="d-flex justify-content-center mb-2">Nì›” Nì£¼ì°¨</div>
                    <div class="d-flex justify-content-between">
                        <div id="prevWeek" class="nav-button">< ì§€ë‚œì£¼</div>
                        <div id="nextWeek" class="nav-button">ë‹¤ìŒì£¼ ></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dayBox" class="d-flex justify-content-between">
            <a href="/main/specific" class="date monday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">ì›”</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDateList.Monday}" th:data-raw-date="${weekDateList.Monday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date tuesday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">í™”</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDateList.Tuesday}" th:data-raw-date="${weekDateList.Tuesday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date wednesday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">ìˆ˜</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDateList.Wednesday}" th:data-raw-date="${weekDateList.Wednesday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date thursday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">ëª©</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDateList.Thursday}" th:data-raw-date="${weekDateList.Thursday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date friday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center">ê¸ˆ</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDateList.Friday}" th:data-raw-date="${weekDateList.Friday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a href="/main/specific" class="date saturday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center text-primary">í† </div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDateList.Saturday}" th:data-raw-date="${weekDateList.Saturday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>
            <a th:href="|/main/specific?date=${weekDates.Sunday}|" class="date sunday">
                <div class="specificDate d-flex align-items-center justify-content-center">
                    <div class="w-100">
                        <div class="d-flex justify-content-center text-danger">ì¼</div>
                        <div class="d-flex justify-content-center">
                            <span class="date-value" th:text="${weekDateList.Sunday}" th:data-raw-date="${weekDateList.Sunday}"></span>
                        </div>
                    </div>
                </div>
                <div class="dateBar d-flex justify-content-center align-items-center">
                    <div class="bar"></div>
                </div>
            </a>

        </div>
    </section>
    <script>
        // ğŸ“Œ Thymeleafì—ì„œ ì£¼ê°„ ì‹œì‘ ë‚ ì§œ(Monday)ë¥¼ ê°€ì ¸ì™€ selectedDateë¡œ ì„¤ì •
        let initialDateStr = document.querySelector(".monday .date-value")?.getAttribute("data-raw-date") || new Date().toISOString().split('T')[0];
        let selectedDate = new Date(initialDateStr); // ì„œë²„ì—ì„œ ë°›ì€ ì›”ìš”ì¼ ë‚ ì§œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •

        // ì£¼ê°„ ë²”ìœ„ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function getWeekRange(date) {
            let day = date.getDay();
            let diff = date.getDate() - day + (day === 0 ? -6 : 1); // ì›”ìš”ì¼ ê¸°ì¤€ìœ¼ë¡œ ì£¼ ì‹œì‘
            let startOfWeek = new Date(date);
            startOfWeek.setDate(diff);

            let endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6); // ì¼ìš”ì¼ì´ ì£¼ ë§ˆì§€ë§‰

            return { start: startOfWeek, end: endOfWeek };
        }

        // ëª‡ ë²ˆì§¸ ì£¼ì¸ì§€ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
        function getMonthWeekNumber(date) {
            let firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);

            // ì²« ì›”ìš”ì¼ ì°¾ê¸°
            let firstMonday = new Date(firstDayOfMonth);
            while (firstMonday.getDay() !== 1) {
                firstMonday.setDate(firstMonday.getDate() + 1);
            }

            let diff = date.getDate() - firstMonday.getDate();
            return Math.floor(diff / 7) + 1;
        }

        // ğŸ“Œ í™”ë©´ì— ì£¼ì°¨ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ì´ˆê¸° ì„¤ì • ì‹œ Thymeleaf ê°’ ë°˜ì˜)
        function updateWeekDisplay() {
            let { start, end } = getWeekRange(selectedDate);
            let month = selectedDate.getMonth() + 1;
            let weekNumber = getMonthWeekNumber(selectedDate);

            document.getElementById("weekLabel").innerText = `${month}ì›” ${weekNumber}ì£¼ì°¨`;
        }

        // ì´ì „ ì£¼ë¡œ ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById("prevWeek").addEventListener("click", function() {
            selectedDate.setDate(selectedDate.getDate() - 7);
            updateWeekDisplay();
            updateWeekDates();
        });

        // ë‹¤ìŒ ì£¼ë¡œ ì´ë™ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById("nextWeek").addEventListener("click", function() {
            selectedDate.setDate(selectedDate.getDate() + 7);
            updateWeekDisplay();
            updateWeekDates();
        });

        // ì„œë²„ì—ì„œ ìƒˆë¡œìš´ ì£¼ê°„ ë‚ ì§œë¥¼ ê°€ì ¸ì™€ í™”ë©´ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateWeekDates() {
            let formattedDate = selectedDate.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹ ë³€í™˜

            $.ajax({
                url: "/main/updateDates",
                type: "POST",
                data: { "date": formattedDate },
                success: function(data) {
                    console.log("Updated week data:", data);

                    let dayKeys = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

                    dayKeys.forEach(day => {
                        let element = document.querySelector(`.${day.toLowerCase()} .date-value`);
                        let linkElement = document.querySelector(`.${day.toLowerCase()}`); // í•´ë‹¹ ìš”ì¼ì˜ <a> íƒœê·¸

                        if (element && data[day]) {
                            let rawDate = data[day]; // ì„œë²„ì—ì„œ ë°›ì€ YYYY-MM-DD í˜•ì‹
                            element.setAttribute("data-raw-date", rawDate); // ì›ë³¸ ë‚ ì§œ ì €ì¥

                            let parts = rawDate.split("-"); // ["2024", "02", "12"]
                            let formattedDate = parts[1] + "/" + parts[2]; // "02/12"
                            element.textContent = formattedDate; // í™”ë©´ì— MM/dd í˜•ì‹ìœ¼ë¡œ í‘œì‹œ

                            // ğŸ“Œ í•´ë‹¹ ìš”ì¼ì˜ <a> íƒœê·¸ì˜ href ì†ì„± ì—…ë°ì´íŠ¸
                            if (linkElement) {
                                linkElement.setAttribute("href", `/main/specific?date=${rawDate}`);
                            }
                        }
                    });

                    // ğŸ“Œ ì£¼ê°„ ìº˜ë¦°ë” ë§í¬ ì—…ë°ì´íŠ¸ â†’ ì£¼ì˜ ì‹œì‘ì¼(ì›”ìš”ì¼) ê¸°ì¤€
                    if (data["Monday"]) {
                        updateCalendarHref(data["Monday"]);
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching week dates:", error);
                }
            });
        }

        // Flatpickr ì„¤ì •
        flatpickr("#weekLabel", {
            enableTime: false,
            dateFormat: "Y-m-d",
            locale: {
                firstDayOfWeek: 1,
                months: {
                    shorthand: [...Array(12)].map((_, i) => `${i + 1}ì›”`),
                    longhand: [...Array(12)].map((_, i) => `${i + 1}ì›”`)
                }
            },
            onChange: function(selectedDates) {
                if (selectedDates.length > 0) {
                    selectedDate = new Date(selectedDates[0]);
                    updateWeekDisplay();
                    updateWeekDates();
                }
            }
        });

        // ğŸ“Œ ì´ˆê¸° ì‹¤í–‰: ê¸°ì¡´ Thymeleaf ë Œë”ë§ëœ ê°’ì„ MM/ddë¡œ ë³€í™˜
        function initializeDateValues() {
            let dateElements = document.querySelectorAll(".date-value");

            dateElements.forEach(function(element) {
                let rawDate = element.textContent.trim(); // ì´ˆê¸° ê°’ ê°€ì ¸ì˜¤ê¸° (yyyy-MM-dd í˜•ì‹)

                if (rawDate && rawDate.includes("-")) {
                    element.setAttribute("data-raw-date", rawDate); // ì›ë³¸ ë‚ ì§œ ì €ì¥

                    let parts = rawDate.split("-"); // ["2024", "02", "12"]
                    let formattedDate = parts[1] + "/" + parts[2]; // "02/12"

                    element.textContent = formattedDate; // í™”ë©´ì— MM/dd í˜•ì‹ìœ¼ë¡œ í‘œì‹œ
                }
            });
        }

        // ğŸ“Œ ì´ˆê¸° ì‹¤í–‰: ì„œë²„ì—ì„œ ë°›ì€ ë‚ ì§œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •
        updateWeekDisplay();
        initializeDateValues();
        updateWeekDates();
    </script>
</th:block>